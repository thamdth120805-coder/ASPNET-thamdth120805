@model IEnumerable<OnlineLearningPlatform.Models.Wishlist>
@{
    ViewData["Title"] = "Danh sách yêu thích";
}

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar bg-light">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("Dashboard", "Member")">
                            <i class="fas fa-tachometer-alt"></i> Tổng quan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("MyCourses", "Member")">
                            <i class="fas fa-book"></i> Khóa học của tôi
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="@Url.Action("Wishlist", "Member")">
                            <i class="fas fa-heart"></i> Danh sách yêu thích
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("Profile", "Member")">
                            <i class="fas fa-user"></i> Thông tin cá nhân
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Danh sách yêu thích</h1>
            </div>

            @if (Model.Any())
            {
                <div class="row">
                    @foreach (var wishlist in Model)
                    {
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="position-relative">
                                    <img src="@(wishlist.Course.ThumbnailUrl ?? "/images/default-course.jpg")" 
                                         class="card-img-top" alt="@wishlist.Course.Title" style="height: 200px; object-fit: cover;">
                                    <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 remove-wishlist" 
                                            data-course-id="@wishlist.Course.Id">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">@wishlist.Course.Title</h5>
                                    <p class="card-text text-muted">@wishlist.Course.Instructor?.User?.FullName</p>
                                    <p class="card-text flex-grow-1">@wishlist.Course.Description</p>
                                    
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="h5 text-primary mb-0">
                                                @if (wishlist.Course.Price > 0)
                                                {
                                                    @(wishlist.Course.Price.ToString("N0") + "đ")
                                                }
                                                else
                                                {
                                                    <span class="text-success">Miễn phí</span>
                                                }
                                            </span>
                                            <small class="text-muted">
                                                <i class="fas fa-star text-warning"></i> @wishlist.Course.Rating
                                            </small>
                                        </div>
                                        
                                        <small class="text-muted d-block mb-3">
                                            Thêm vào ngày @wishlist.AddedAt.ToString("dd/MM/yyyy")
                                        </small>
                                        
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary enroll-course" data-course-id="@wishlist.Course.Id">
                                                <i class="fas fa-plus"></i> Đăng ký học
                                            </button>
                                            <a href="@Url.Action("Details", "Courses", new { id = wishlist.Course.Id })" 
                                               class="btn btn-outline-secondary">
                                                <i class="fas fa-eye"></i> Xem chi tiết
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-heart fa-4x text-muted mb-4"></i>
                    <h3>Danh sách yêu thích trống</h3>
                    <p class="text-muted mb-4">Bạn chưa thêm khóa học nào vào danh sách yêu thích. Hãy khám phá và lưu lại những khóa học bạn quan tâm!</p>
                    <a href="@Url.Action("Index", "Courses")" class="btn btn-primary btn-lg">
                        <i class="fas fa-search"></i> Khám phá khóa học
                    </a>
                </div>
            }
        </main>
    </div>
</div>

<style>
.sidebar {
    min-height: calc(100vh - 56px);
}

.sidebar .nav-link {
    color: #333;
    padding: 10px 15px;
    border-radius: 5px;
    margin-bottom: 5px;
}

.sidebar .nav-link:hover,
.sidebar .nav-link.active {
    background-color: #007bff;
    color: white;
}
</style>

<script>
$(document).ready(function() {
    // Xóa khỏi wishlist
    $('.remove-wishlist').click(function() {
        var courseId = $(this).data('course-id');
        var card = $(this).closest('.col-md-6');
        
        $.post('@Url.Action("RemoveFromWishlist", "Member")', { courseId: courseId })
            .done(function(response) {
                if (response.success) {
                    card.fadeOut(300, function() {
                        $(this).remove();
                        if ($('.col-md-6').length === 0) {
                            location.reload();
                        }
                    });
                    toastr.success(response.message);
                } else {
                    toastr.error(response.message);
                }
            })
            .fail(function() {
                toastr.error('Có lỗi xảy ra, vui lòng thử lại');
            });
    });

    // Đăng ký khóa học
    $('.enroll-course').click(function() {
        var courseId = $(this).data('course-id');
        var button = $(this);
        
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');
        
        $.post('@Url.Action("EnrollCourse", "Member")', { courseId: courseId })
            .done(function(response) {
                if (response.success) {
                    toastr.success(response.message);
                    button.removeClass('btn-primary').addClass('btn-success')
                          .html('<i class="fas fa-check"></i> Đã đăng ký');
                } else {
                    toastr.error(response.message);
                    button.prop('disabled', false).html('<i class="fas fa-plus"></i> Đăng ký học');
                }
            })
            .fail(function() {
                toastr.error('Có lỗi xảy ra, vui lòng thử lại');
                button.prop('disabled', false).html('<i class="fas fa-plus"></i> Đăng ký học');
            });
    });
});
</script>